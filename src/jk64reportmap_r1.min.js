$(function(){$.widget("jk64.reportmap",{options:{regionId:"",ajaxIdentifier:"",ajaxItems:"",pluginFilePrefix:"",expectData:!0,initialCenter:{lat:0,lng:0},minZoom:1,maxZoom:null,initialZoom:2,southwest:null,northeast:null,visualisation:"pins",mapType:"roadmap",clickZoomLevel:null,isDraggable:!1,heatmapDissipating:!1,heatmapOpacity:.6,heatmapRadius:5,panOnClick:!0,restrictCountry:"",mapStyle:"",travelMode:"DRIVING",optimizeWaypoints:!1,allowZoom:!0,allowPan:!0,gestureHandling:"auto",initFn:null,noDataMessage:"No data to show",noAddressResults:"Address not found",directionsNotFound:"At least one of the origin, destination, or waypoints could not be geocoded.",directionsZeroResults:"No route could be found between the origin and destination.",parseLatLng:null,click:null,geolocate:null,gotoAddress:null,gotoPos:null,gotoPosByString:null,refresh:null,getAddressByPos:null,showDirections:null},parseLatLng:function(e){var t,i;(apex.debug("reportmap.parseLatLng "+e),null!=e)&&(e.indexOf(";")>-1?i=e.split(";"):e.indexOf(" ")>-1?i=e.split(" "):e.indexOf(",")>-1&&(i=e.split(",")),i&&2==i.length?(i[0]=i[0].replace(/,/g,"."),i[1]=i[1].replace(/,/g,"."),apex.debug("parsed "+i[0]+" "+i[1]),t=new google.maps.LatLng(parseFloat(i[0]),parseFloat(i[1]))):apex.debug('no LatLng found in "'+e+'"'));return t},_showMessage:function(e){apex.debug("reportmap._showMessage '"+e+"'"),this.infoWindow?this.infoWindow.close():this.infoWindow=new google.maps.InfoWindow({content:e,position:this.map.getCenter()}),this.infoWindow.open(this.map)},_hideMessage:function(){apex.debug("reportmap._hideMessage "),this.infoWindow&&this.infoWindow.close()},_pinData:function(e,t){var i={map:this.map,id:e.d,name:e.n,lat:t.lat(),lng:t.lng()};return e.f&&(e.f.a1&&(i.attr01=e.f.a1),e.f.a2&&(i.attr02=e.f.a2),e.f.a3&&(i.attr03=e.f.a3),e.f.a4&&(i.attr04=e.f.a4),e.f.a5&&(i.attr05=e.f.a5),e.f.a6&&(i.attr06=e.f.a6),e.f.a7&&(i.attr07=e.f.a7),e.f.a8&&(i.attr08=e.f.a8),e.f.a9&&(i.attr09=e.f.a9),e.f.a10&&(i.attr10=e.f.a10)),i},_marker:function(e){var t=new google.maps.Marker({map:this.map,position:new google.maps.LatLng(e.x,e.y),title:e.n,icon:e.c,label:e.l,draggable:this.options.isDraggable});t.reportmapId=e.d;var i=this;return google.maps.event.addListener(t,"click",function(){apex.debug("marker "+e.d+" clicked");var t=this.getPosition();if(e.i){i.infoWindow?i.infoWindow.close():i.infoWindow=new google.maps.InfoWindow;var o=(new DOMParser).parseFromString(e.i,"text/html");i.infoWindow.setOptions({content:o.documentElement.textContent}),i.infoWindow.open(i.map,this)}i.options.panOnClick&&i.map.panTo(t),i.options.clickZoomLevel&&i.map.setZoom(i.options.clickZoomLevel),apex.jQuery("#"+i.options.regionId).trigger("markerclick",i._pinData(e,t))}),google.maps.event.addListener(t,"dragend",function(){var t=this.getPosition();apex.debug("marker "+e.d+" moved to "+JSON.stringify(t)),apex.jQuery("#"+i.options.regionId).trigger("markerdrag",i._pinData(e,t))}),t},_showData:function(e){if(apex.debug("reportmap._showData"),e.length>0){this._hideMessage();var t=[];this.markers=[];for(var i=0;i<e.length;i++)"heatmap"==this.options.visualisation?t.push({location:new google.maps.LatLng(e[i][0],e[i][1]),weight:e[i][2]}):this.markers.push(this._marker(e[i]));switch(this.options.visualisation){case"cluster":new MarkerClusterer(this.map,this.markers,{imagePath:this.imagePrefix});break;case"heatmap":this.heatmapLayer&&(apex.debug("remove heatmapLayer"),this.heatmapLayer.setMap(null),this.heatmapLayer.delete,this.heatmapLayer=null),this.heatmapLayer=new google.maps.visualization.HeatmapLayer({data:t,map:this.map,dissipating:this.options.heatmapDissipating,opacity:this.options.heatmapOpacity,radius:this.options.heatmapRadius})}}else""!==this.options.noDataMessage&&(apex.debug("show No Data Found infowindow"),this._showMessage(this.options.noDataMessage))},_removeMarkers:function(){if(apex.debug("reportmap._removeMarkers"),this.markers){for(var e=0;e<this.markers.length;e++)this.markers[e].setMap(null);this.markers.delete}},gotoPos:function(e,t){if(apex.debug("reportmap.gotoPos "+e+" "+t),null!==e&&null!==t){var i=this.userpin?this.userpin.getPosition():new google.maps.LatLng(0,0);if(i&&e==i.lat()&&t==i.lng())apex.debug("userpin not changed");else{var o=new google.maps.LatLng(e,t);this.userpin?(apex.debug("move existing pin to new position on map "+e+","+t),this.userpin.setMap(this.map),this.userpin.setPosition(o)):(apex.debug("create userpin "+e+","+t),this.userpin=new google.maps.Marker({map:this.map,position:o}))}}else this.userpin&&(apex.debug("move existing pin off the map"),this.userpin.setMap(null))},gotoPosByString:function(e){apex.debug("reportmap.gotoPosByString");var t=this.parseLatLng(e);t&&this.gotoPos(t.lat(),t.lng())},gotoAddress:function(e){apex.debug("reportmap.gotoAddress");var t=new google.maps.Geocoder;this._hideMessage();var i=this;t.geocode({address:e,componentRestrictions:""!==i.options.restrictCountry?{country:i.options.restrictCountry}:{}},function(e,t){if(t===google.maps.GeocoderStatus.OK){var o=e[0].geometry.location;apex.debug("geocode ok"),i.map.setCenter(o),i.map.panTo(o),i.options.clickZoomLevel&&i.map.setZoom(i.options.clickZoomLevel),i.gotoPos(o.lat(),o.lng()),apex.debug("addressfound '"+e[0].formatted_address+"'"),apex.jQuery("#"+i.options.regionId).trigger("addressfound",{map:i.map,lat:o.lat(),lng:o.lng(),result:e[0]})}else apex.debug("Geocoder failed: "+t)})},click:function(e){apex.debug("reportmap.click");var t=this.markers.find(function(t){return t.reportmapId==e});t?new google.maps.event.trigger(t,"click"):apex.debug("id not found:"+e)},getAddressByPos:function(e,t){apex.debug("reportmap.getAddressByPos");var o=new google.maps.Geocoder;this._hideMessage();var s=this;o.geocode({location:{lat:e,lng:t}},function(o,a){if(a===google.maps.GeocoderStatus.OK)if(o[0]){apex.debug("addressfound '"+o[0].formatted_address+"'");var n=o[0].address_components;for(i=0;i<n.length;i++)apex.debug("result[0] "+n[i].types+"="+n[i].short_name+" ("+n[i].long_name+")");apex.jQuery("#"+s.options.regionId).trigger("addressfound",{map:s.map,lat:e,lng:t,result:o[0]})}else apex.debug("getAddressByPos: No results found"),s._showMessage(s.options.noAddressResults);else apex.debug("Geocoder failed: "+a)})},geolocate:function(){if(apex.debug("reportmap.geolocate"),navigator.geolocation){apex.debug("geolocate");var e=this;navigator.geolocation.getCurrentPosition(function(t){var i={lat:t.coords.latitude,lng:t.coords.longitude};e.map.panTo(i),e.options.geolocateZoom&&e.map.setZoom(e.options.geolocateZoom),apex.jQuery("#"+e.options.regionId).trigger("geolocate",{map:e.map,lat:i.lat,lng:i.lng})})}else apex.debug("browser does not support geolocation")},_directionsResponse:function(e,t){switch(apex.debug("reportmap._directionsResponse "+t),t){case google.maps.DirectionsStatus.OK:this.directionsDisplay.setDirections(e);for(var i=0,o=0,s=0,a=0;a<e.routes.length;a++){s+=e.routes[a].legs.length;for(var n=0;n<e.routes[a].legs.length;n++){var r=e.routes[a].legs[n];i+=r.distance.value,o+=r.duration.value}}apex.jQuery("#"+this.options.regionId).trigger("directions",{map:this.map,distance:i,duration:o,legs:s});break;case google.maps.DirectionsStatus.NOT_FOUND:this._showMessage(this.options.directionsNotFound);break;case google.maps.DirectionsStatus.ZERO_RESULTS:this._showMessage(this.options.directionsZeroResults);break;default:apex.debug("Directions request failed: "+t)}},showDirections:function(e,t,i){if(apex.debug("reportmap.showDirections"),this.origin=e,this.destination=t,this._hideMessage(),this.origin&&this.destination)if(this.directionsDisplay||(this.directionsDisplay=new google.maps.DirectionsRenderer,this.directionsService=new google.maps.DirectionsService,this.directionsDisplay.setMap(this.map)),this.origin=this.parseLatLng(this.origin)||this.origin,this.destination=this.parseLatLng(this.destination)||this.destination,""!==this.origin&&""!==this.destination){var o=this;this.directionsService.route({origin:this.origin,destination:this.destination,travelMode:google.maps.TravelMode[i||"DRIVING"]},function(e,t){o._directionsResponse(e,t)})}else apex.debug("No directions to show - need both origin and destination location");else apex.debug("Unable to show directions: no data, no origin/destination")},_directions:function(e){if(apex.debug("reportmap._directions "+e.length+" waypoints"),e.length>1){var t,i;this.directionsDisplay||(this.directionsDisplay=new google.maps.DirectionsRenderer,this.directionsService=new google.maps.DirectionsService,this.directionsDisplay.setMap(this.map));for(var o,s=[],a=0;a<e.length;a++)o=new google.maps.LatLng(e[a].x,e[a].y),0==a?t=o:a==e.length-1?i=o:s.push({location:o,stopover:!0});apex.debug("origin="+t+" dest="+i+" waypoints:"+s.length+" via:"+this.options.travelMode);var n=this;this.directionsService.route({origin:t,destination:i,waypoints:s,optimizeWaypoints:this.options.optimizeWaypoints,travelMode:google.maps.TravelMode[this.options.travelMode]},function(e,t){n._directionsResponse(e,t)})}else apex.debug("not enough waypoints - need at least an origin and a destination point")},_create:function(){apex.debug("reportmap._create "+this.element.prop("id")),apex.debug("options: "+JSON.stringify(this.options));var e=this,t=window.location.origin+window.location.pathname;t=t.substring(0,t.lastIndexOf("/")),this.imagePrefix=t+"/"+this.options.pluginFilePrefix+"images/m",apex.debug('this.imagePrefix="'+this.imagePrefix+'"');var i={minZoom:this.options.minZoom,maxZoom:this.options.maxZoom,zoom:this.options.initialZoom,center:this.options.initialCenter,mapTypeId:this.options.mapType,draggable:this.options.allowPan,zoomControl:this.options.allowZoom,scrollwheel:this.options.allowZoom,disableDoubleClickZoom:!this.options.allowZoom,gestureHandling:this.options.gestureHandling};this.options.mapStyle&&(i.styles=this.options.mapStyle),this.map=new google.maps.Map(document.getElementById(this.element.prop("id")),i),this.options.southwest&&this.options.northeast&&this.map.fitBounds(new google.maps.LatLngBounds(this.options.southwest,this.options.northeast)),google.maps.event.addListener(this.map,"click",function(t){apex.debug("map clicked "+JSON.stringify(t.latLng)),e.options.clickZoomLevel&&(apex.debug("pan+zoom"),e.options.panOnClick&&e.map.panTo(t.latLng),e.map.setZoom(e.options.clickZoomLevel)),apex.jQuery("#"+e.options.regionId).trigger("mapclick",{map:e.map,lat:t.latLng.lat(),lng:t.latLng.lng()})}),apex.jQuery("#"+this.options.regionId).bind("apexrefresh",function(){$("#map_"+e.options.regionId).reportmap("refresh")}),this.options.initFn&&(apex.debug("running init_javascript_code..."),this.init=this.options.initFn,this.init()),this.options.expectData&&this.refresh(),apex.jQuery("#"+this.options.regionId).trigger("maploaded",{map:this.map}),apex.debug("reportmap.init finished")},refresh:function(){if(apex.debug("reportmap.refresh"),this._hideMessage(),this.options.expectData){apex.jQuery("#"+this.options.regionId).trigger("apexbeforerefresh");var e=this;apex.server.plugin(this.options.ajaxIdentifier,{pageItems:this.options.ajaxItems},{dataType:"json",success:function(t){apex.debug("success southwest="+JSON.stringify(t.southwest)+" northeast="+JSON.stringify(t.northeast)),e.map.fitBounds({south:t.southwest.lat,west:t.southwest.lng,north:t.northeast.lat,east:t.northeast.lng}),e.infoWindow&&e.infoWindow.close(),apex.debug("pData.mapdata.length="+t.mapdata.length),e._removeMarkers(),t.mapdata&&(e._showData(t.mapdata),"directions"==e.options.visualisation&&e._directions(t.mapdata)),apex.jQuery("#"+e.options.regionId).trigger("apexafterrefresh")}})}apex.debug("reportmap.refresh finished"),this._trigger("change")},_destroy:function(){this.heatmapLayer&&this.heatmapLayer.remove(),this.userpin&&delete this.userpin,this.directionsDisplay&&delete this.directionsDisplay,this.directionsService&&delete this.directionsService,this._removeMarkers(),this._hideMessage(),this.map.remove()},_setOptions:function(){this._superApply(arguments),this.refresh()},_setOption:function(e,t){this._super(e,t)}})});