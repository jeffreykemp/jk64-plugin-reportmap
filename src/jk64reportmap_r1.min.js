$((function(){$.widget("jk64.reportmap",{options:{regionId:"",ajaxIdentifier:"",ajaxItems:"",pluginFilePrefix:"",expectData:!0,maximumRows:null,rowsPerBatch:null,initialCenter:{lat:0,lng:0},minZoom:1,maxZoom:null,initialZoom:2,visualisation:"pins",mapType:"roadmap",clickZoomLevel:null,isDraggable:!1,heatmapDissipating:!1,heatmapOpacity:.6,heatmapRadius:5,panOnClick:!0,restrictCountry:"",mapStyle:"",travelMode:"DRIVING",optimizeWaypoints:!1,allowZoom:!0,allowPan:!0,gestureHandling:"auto",initFn:null,markerFormatFn:null,drawingModes:null,featureColor:"#cc66ff",featureColorSelected:"#ff6600",featureSelectable:!0,featureHoverable:!0,featureStyleFn:null,dragDropGeoJSON:!1,autoFitBounds:!0,directionsPanel:null,spiderfier:{},spiderfyFormatFn:null,showSpinner:!0,iconBasePath:"",noDataMessage:"No data to show",noAddressResults:"Address not found",directionsNotFound:"At least one of the origin, destination, or waypoints could not be geocoded.",directionsZeroResults:"No route could be found between the origin and destination.",click:null,deleteAllFeatures:null,deleteSelectedFeatures:null,fitBounds:null,geolocate:null,getAddressByPos:null,gotoAddress:null,gotoPos:null,gotoPosByString:null,hideMessage:null,loadGeoJsonString:null,panTo:null,panToByString:null,parseLatLng:null,refresh:null,showDirections:null,showInfoWindow:null,showMessage:null},parseLatLng:function(e){var t,o;(apex.debug("reportmap.parseLatLng",e),null!=e)&&(e.hasOwnProperty("lat")&&e.hasOwnProperty("lng")?t=new google.maps.LatLng(e):(e.indexOf(";")>-1?o=e.split(";"):e.indexOf(" ")>-1?o=e.split(" "):e.indexOf(",")>-1&&(o=e.split(",")),o&&2==o.length?(o[0]=o[0].replace(/,/g,"."),o[1]=o[1].replace(/,/g,"."),apex.debug("parsed",o),t=new google.maps.LatLng(parseFloat(o[0]),parseFloat(o[1]))):apex.debug("no LatLng found",e)));return t},showMessage:function(e){apex.debug("reportmap.showMessage",e),this.hideMessage(),this.msgDiv=document.createElement("div");var t=document.createElement("div");t.className="reportmap-messageUI",this.msgDiv.appendChild(t);var o=document.createElement("div");o.className="reportmap-messageInner",o.innerHTML=e,t.appendChild(o),this.msgDiv.addEventListener("click",(function(){apex.debug("on click - hide message"),this.remove()})),this.map.controls[google.maps.ControlPosition.LEFT_CENTER].push(this.msgDiv)},hideMessage:function(){apex.debug("reportmap.hideMessage"),this.msgDiv&&this.msgDiv.remove()},_eventPinData:function(e){var t={map:this.map,lat:e.position.lat(),lng:e.position.lng(),marker:e};return $.extend(t,e.data),t},showInfoWindow:function(e){apex.debug("reportmap.showInfoWindow",e),this.infoWindow||(this.infoWindow=new google.maps.InfoWindow);var t=(new DOMParser).parseFromString(e.data.info,"text/html");this.infoWindow.setContent(t.documentElement.textContent),this.infoWindow.open(this.map,e)},_newMarker:function(e){var t=this,o=new google.maps.Marker({map:this.map,position:new google.maps.LatLng(e.x,e.y),title:e.n,icon:e.c?this.options.iconBasePath+e.c:null,label:e.l,draggable:this.options.isDraggable});o.data={id:e.d,info:e.i,name:e.n};for(var a=1;a<=10;a++)e.f&&e.f["a"+a]&&(o.data["attr"+("0"+a).slice(-2)]=e.f["a"+a]);return this.options.markerFormatFn&&this.options.markerFormatFn(o),google.maps.event.addListener(o,"spiderfier"==this.options.visualisation?"spider_click":"click",(function(){apex.debug("marker clicked",o.data.id);var e=this.getPosition();o.data.info&&t.showInfoWindow(this),t.options.panOnClick&&t.map.panTo(e),t.options.clickZoomLevel&&t.map.setZoom(t.options.clickZoomLevel),apex.jQuery("#"+t.options.regionId).trigger("markerclick",t._eventPinData(o))})),google.maps.event.addListener(o,"dragend",(function(){var e=this.getPosition();apex.debug("marker moved",o.data.id,JSON.stringify(e)),apex.jQuery("#"+t.options.regionId).trigger("markerdrag",t._eventPinData(o))})),["pins","cluster","spiderfier"].indexOf(this.options.visualisation)>-1&&(this.idMap&&this.idMap.has(o.data.id)||apex.jQuery("#"+t.options.regionId).trigger("markeradded",t._eventPinData(o))),o},_spiderfy:function(){apex.debug("reportmap._spiderfy");var e=this,t={keepSpiderfied:!0,basicFormatEvents:!0,markersWontMove:!this.options.isDraggable,markersWontHide:!0};$.extend(t,this.options.spiderfier),this.oms=new OverlappingMarkerSpiderfier(this.map,t),this.oms.addListener("format",this.options.spiderfyFormatFn||function(e,t){var o=t==OverlappingMarkerSpiderfier.markerStatus.SPIDERFIED?"https://mt.googleapis.com/vt/icon/name=icons/spotlight/spotlight-waypoint-blue.png":t==OverlappingMarkerSpiderfier.markerStatus.SPIDERFIABLE?"https://mt.googleapis.com/vt/icon/name=icons/spotlight/spotlight-waypoint-a.png":"https://mt.googleapis.com/vt/icon/name=icons/spotlight/spotlight-poi.png";e.setIcon({url:o})});for(var o=0;o<this.markers.length;o++)this.oms.addMarker(this.markers[o]);this.oms.addListener("spiderfy",(function(t){apex.debug("spiderfy",t),apex.jQuery("#"+e.options.regionId).trigger("spiderfy",{map:e.map,markers:t})})),this.oms.addListener("unspiderfy",(function(t){apex.debug("unspiderfy",t),apex.jQuery("#"+e.options.regionId).trigger("unspiderfy",{map:e.map,markers:t})}))},_removeMarkers:function(){if(apex.debug("reportmap._removeMarkers"),this.totalRows=0,this.bounds&&this.bounds.delete,this.markers){for(var e=0;e<this.markers.length;e++)this.markers[e].setMap(null);this.markers.delete}},click:function(e){apex.debug("reportmap.click");var t=this.markers.find((function(t){return t.data.id==e}));t?new google.maps.event.trigger(t,"click"):apex.debug("id not found",e)},gotoPos:function(e,t){if(apex.debug("reportmap.gotoPos",e,t),null!==e&&null!==t){var o=this.userpin?this.userpin.getPosition():new google.maps.LatLng(0,0);if(o&&e==o.lat()&&t==o.lng())apex.debug("userpin not changed");else{var a=new google.maps.LatLng(e,t);if(this.userpin)apex.debug("move existing pin to new position on map",a),this.userpin.setMap(this.map),this.userpin.setPosition(a);else{apex.debug("create userpin",a),this.userpin=new google.maps.Marker({map:this.map,position:a,draggable:this.options.isDraggable});var i=this;google.maps.event.addListener(this.userpin,"dragend",(function(){var e=this.getPosition();apex.debug("userpin moved",JSON.stringify(e)),apex.jQuery("#"+i.options.regionId).trigger("markerdrag",{map:i.map,lat:e.lat(),lng:e.lng(),marker:this})}))}}}else this.userpin&&(apex.debug("move existing pin off the map"),this.userpin.setMap(null))},gotoPosByString:function(e){apex.debug("reportmap.gotoPosByString",e);var t=this.parseLatLng(e);t&&this.gotoPos(t.lat(),t.lng())},panTo:function(e,t){if(apex.debug("reportmap.panTo",e,t),null!==e&&null!==t){var o=new google.maps.LatLng(e,t);this.map.panTo(o)}},panToByString:function(e){apex.debug("reportmap.panToByString",e);var t=this.parseLatLng(e);t&&this.panTo(t.lat(),t.lng())},fitBounds:function(e){var t;(apex.debug("reportmap.fitBounds",e),null!=e)&&((t=e.hasOwnProperty("east")&&e.hasOwnProperty("north")&&e.hasOwnProperty("south")&&e.hasOwnProperty("west")?new google.maps.LatLngBoundsLiteral(e):JSON.parse(e))&&this.map.fitBounds(t))},gotoAddress:function(e){apex.debug("reportmap.gotoAddress",e);var t=new google.maps.Geocoder;this.hideMessage();var o=this;t.geocode({address:e,componentRestrictions:""!==o.options.restrictCountry?{country:o.options.restrictCountry}:{}},(function(e,t){if(t===google.maps.GeocoderStatus.OK){var a=e[0].geometry.location;apex.debug("geocode ok",a),o.map.setCenter(a),o.map.panTo(a),o.options.clickZoomLevel&&o.map.setZoom(o.options.clickZoomLevel),o.gotoPos(a.lat(),a.lng()),apex.debug("addressfound",e),apex.jQuery("#"+o.options.regionId).trigger("addressfound",{map:o.map,lat:a.lat(),lng:a.lng(),result:e[0]})}else t===google.maps.GeocoderStatus.ZERO_RESULTS?(apex.debug("getAddressByPos: ZERO_RESULTS"),o.showMessage(o.options.noAddressResults)):apex.debug("Geocoder failed",t)}))},getAddressByPos:function(e,t){apex.debug("reportmap.getAddressByPos",e,t);var o=new google.maps.Geocoder;this.hideMessage();var a=this;o.geocode({location:{lat:e,lng:t}},(function(o,i){i===google.maps.GeocoderStatus.OK?o[0]?(apex.debug("addressfound",o),apex.jQuery("#"+a.options.regionId).trigger("addressfound",{map:a.map,lat:e,lng:t,result:o[0]})):(apex.debug("getAddressByPos: No results returned"),a.showMessage(a.options.noAddressResults)):i===google.maps.GeocoderStatus.ZERO_RESULTS?(apex.debug("getAddressByPos: ZERO_RESULTS"),a.showMessage(a.options.noAddressResults)):apex.debug("Geocoder failed",i)}))},geolocate:function(){if(apex.debug("reportmap.geolocate"),navigator.geolocation){var e=this;navigator.geolocation.getCurrentPosition((function(t){var o={lat:t.coords.latitude,lng:t.coords.longitude};e.map.panTo(o),e.options.geolocateZoom&&e.map.setZoom(e.options.geolocateZoom),apex.jQuery("#"+e.options.regionId).trigger("geolocate",{map:e.map,lat:o.lat,lng:o.lng})}))}else apex.debug("browser does not support geolocation")},_directionsResponse:function(e,t){switch(apex.debug("reportmap._directionsResponse",e,t),t){case google.maps.DirectionsStatus.OK:this.directionsDisplay.setDirections(e);for(var o=0,a=0,i=0,s=0;s<e.routes.length;s++){i+=e.routes[s].legs.length;for(var n=0;n<e.routes[s].legs.length;n++){var r=e.routes[s].legs[n];o+=r.distance.value,a+=r.duration.value}}apex.jQuery("#"+this.options.regionId).trigger("directions",{map:this.map,distance:o,duration:a,legs:i,directions:e});break;case google.maps.DirectionsStatus.NOT_FOUND:this.showMessage(this.options.directionsNotFound);break;case google.maps.DirectionsStatus.ZERO_RESULTS:this.showMessage(this.options.directionsZeroResults);break;default:apex.debug("Directions request failed",t)}},showDirections:function(e,t,o){if(apex.debug("reportmap.showDirections",e,t,o),this.origin=e,this.destination=t,this.hideMessage(),this.origin&&this.destination)if(this.directionsDisplay||(this.directionsDisplay=new google.maps.DirectionsRenderer,this.directionsService=new google.maps.DirectionsService,this.directionsDisplay.setMap(this.map),this.options.directionsPanel&&this.directionsDisplay.setPanel(document.getElementById(this.options.directionsPanel))),this.origin=this.parseLatLng(this.origin)||this.origin,this.destination=this.parseLatLng(this.destination)||this.destination,""!==this.origin&&""!==this.destination){var a=this;this.directionsService.route({origin:this.origin,destination:this.destination,travelMode:google.maps.TravelMode[o||"DRIVING"]},(function(e,t){a._directionsResponse(e,t)}))}else apex.debug("No directions to show - need both origin and destination location");else apex.debug("Unable to show directions: no data, no origin/destination")},_directions:function(){if(apex.debug("reportmap._directions "+this.markers.length+" waypoints"),this.markers.length>1){this.directionsDisplay||(this.directionsDisplay=new google.maps.DirectionsRenderer,this.directionsService=new google.maps.DirectionsService,this.directionsDisplay.setMap(this.map),this.options.directionsPanel&&this.directionsDisplay.setPanel(document.getElementById(this.options.directionsPanel)));for(var e=this.markers[0].position,t=this.markers[this.markers.length-1].position,o=[],a=1;a<this.markers.length-1;a++)o.push({location:this.markers[a].position,stopover:!0});apex.debug(e,t,o,this.options.travelMode);var i=this;this.directionsService.route({origin:e,destination:t,waypoints:o,optimizeWaypoints:this.options.optimizeWaypoints,travelMode:google.maps.TravelMode[this.options.travelMode]},(function(e,t){i._directionsResponse(e,t)}))}else apex.debug("not enough waypoints - need at least an origin and a destination point")},deleteSelectedFeatures:function(){apex.debug("reportmap.deleteSelectedFeatures");var e=this.map.data;e.forEach((function(t){t.getProperty("isSelected")&&(apex.debug("remove",t),e.remove(t))}))},deleteAllFeatures:function(){apex.debug("reportmap.deleteAllFeatures");var e=this.map.data;e.forEach((function(t){apex.debug("remove",t),e.remove(t)}))},_addControl:function(e,t,o){var a=document.createElement("div"),i=document.createElement("div");i.className="reportmap-controlUI",i.title=t,a.appendChild(i);var s=document.createElement("div");s.className="reportmap-controlInner",s.style.backgroundImage=e,i.appendChild(s),i.addEventListener("click",o),this.map.controls[google.maps.ControlPosition.TOP_CENTER].push(a)},_addCheckbox:function(e,t,o){var a=document.createElement("div"),i=document.createElement("div");i.className="reportmap-controlUI",i.title=o,a.appendChild(i);var s=document.createElement("div");s.className="reportmap-controlInner",i.appendChild(s);var n=document.createElement("input");n.setAttribute("type","checkbox"),n.setAttribute("id",e+"_"+this.options.regionId),n.setAttribute("name",e),n.setAttribute("value","Y"),n.className="reportmap-controlCheckbox",n.className="reportmap-checkbox",s.appendChild(n);var r=document.createElement("label");r.setAttribute("for",e+"_"+this.options.regionId),r.innerHTML=t,r.className="reportmap-controlCheckboxLabel",s.appendChild(r),this.map.controls[google.maps.ControlPosition.TOP_CENTER].push(a)},_addPoint:function(e,t){apex.debug("reportmap._addPoint",e,t),e.add(new google.maps.Data.Feature({geometry:new google.maps.Data.Point(t)}))},_addPolygon:function(e,t){apex.debug("reportmap._addPolygon",e,t),$("#hole_"+this.options.regionId).prop("checked")?e.forEach((function(e){if(e.getProperty("isSelected")){var o=e.getGeometry();if("Polygon"==o.getType()){var a=o.getArray();a.push(new google.maps.Data.LinearRing(t)),e.setGeometry(new google.maps.Data.Polygon(a))}}})):e.add(new google.maps.Data.Feature({geometry:new google.maps.Data.Polygon([t])}))},_initFeatures:function(){apex.debug("reportmap._initFeatures");var e=this,t=this.map.data;t.setStyle(this.options.featureStyleFn||function(t){var o=e.options.featureColor;return t.getProperty("isSelected")&&(o=e.options.featureColorSelected),{fillColor:o,strokeColor:o,strokeWeight:1,draggable:e.options.isDraggable,editable:!1}}),this.options.featureSelectable&&t.addListener("click",(function(t){apex.debug("reportmap.map.data - click",t),t.feature.getProperty("isSelected")?(apex.debug("isSelected","false"),t.feature.removeProperty("isSelected"),apex.jQuery("#"+e.options.regionId).trigger("unselectfeature",{map:e.map,feature:t.feature})):(apex.debug("isSelected","true"),t.feature.setProperty("isSelected",!0),apex.jQuery("#"+e.options.regionId).trigger("selectfeature",{map:e.map,feature:t.feature}))})),this.options.featureHoverable&&(t.addListener("mouseover",(function(o){apex.debug("reportmap.map.data","mouseover",o),t.revertStyle(),t.overrideStyle(o.feature,{strokeWeight:4}),apex.jQuery("#"+e.options.regionId).trigger("mouseoverfeature",{map:e.map,feature:o.feature})})),t.addListener("mouseout",(function(o){apex.debug("reportmap.map.data","mouseout",o),t.revertStyle(),apex.jQuery("#"+e.options.regionId).trigger("mouseoutfeature",{map:e.map,feature:o.feature})})))},_initDrawing:function(){apex.debug("reportmap._initDrawing",this.options.drawingModes);var e=this,t=this.map.data;this.options.drawingModes.indexOf("polygon")>-1&&this._addCheckbox("hole","Hole","Subtract hole from polygon"),this._addControl("url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAUCAYAAACNiR0NAAAA5ElEQVQ4jc3UP0oDQRTH8U9URGSx9ASewcoz5AAL9rYexc4T2FhY6gEE0TMIQS2VFEHEgCYpfMU62cz+0SI/GPbxfr/58mYYlnXXoMEvcZD0HnGxasNWBnaEY5wl/VM847YrcB93uEn6h+G10gjzjmuUAw57AIc54AamEXzBddT3fo4/j95T1NPY8wtQ1QzjqMe4jPohFlwlmVkOCG/x3cOkxp+EV83+GVj0ARb/PeE2vmr8T+z0AZJceEN2JfC1AdI5W2r/qMs2Ey4dI6OlbN3vq8AJdiu9TXwnuQ+c473DAGugBV7oWWGmvidcAAAAAElFTkSuQmCC')","Delete selected features",(function(t){e.deleteSelectedFeatures()}));var o=new google.maps.drawing.DrawingManager({drawingControlOptions:{position:google.maps.ControlPosition.TOP_CENTER,drawingModes:this.options.drawingModes}});o.setMap(this.map),google.maps.event.addListener(o,"overlaycomplete",(function(o){switch(apex.debug("reportmap.overlaycomplete",o),o.type){case google.maps.drawing.OverlayType.MARKER:e._addPoint(t,o.overlay.getPosition());break;case google.maps.drawing.OverlayType.POLYGON:var a=o.overlay.getPath().getArray();e._addPolygon(t,a);break;case google.maps.drawing.OverlayType.RECTANGLE:var i=o.overlay.getBounds();a=[i.getSouthWest(),{lat:i.getSouthWest().lat(),lng:i.getNorthEast().lng()},i.getNorthEast(),{lng:i.getSouthWest().lng(),lat:i.getNorthEast().lat()}];e._addPolygon(t,a);break;case google.maps.drawing.OverlayType.POLYLINE:t.add(new google.maps.Data.Feature({geometry:new google.maps.Data.LineString(o.overlay.getPath().getArray())}));break;case google.maps.drawing.OverlayType.CIRCLE:t.add(new google.maps.Data.Feature({properties:{radius:o.overlay.getRadius()},geometry:new google.maps.Data.Point(o.overlay.getCenter())}))}o.overlay.setMap(null)})),t.setStyle((function(t){var o,a=e.options.featureColor,i=!1;return t.getProperty("isSelected")&&(a=e.options.featureColorSelected,i=!$("#hole_"+e.options.regionId).prop("checked")),o={fillColor:a,strokeColor:a,strokeWeight:1},e.options.featureStyleFn&&$.extend(o,e.options.featureStyleFn(t)),$.extend(o,{draggable:i,editable:i})})),t.addListener("addfeature",(function(t){apex.debug("reportmap.map.data","addfeature",t),apex.jQuery("#"+e.options.regionId).trigger("addfeature",{map:e.map,feature:t.feature})})),t.addListener("removefeature",(function(t){apex.debug("reportmap.map.data","removefeature",t),apex.jQuery("#"+e.options.regionId).trigger("removefeature",{map:e.map,feature:t.feature})})),t.addListener("setgeometry",(function(t){apex.debug("reportmap.map.data","setgeometry",t),apex.jQuery("#"+e.options.regionId).trigger("setgeometry",{map:e.map,feature:t.feature,newGeometry:t.newGeometry,oldGeometry:t.oldGeometry})})),document.addEventListener("keydown",(function(t){"Delete"===t.key&&e.deleteSelectedFeatures()}))},_processPoints:function(e,t,o){var a=this;e instanceof google.maps.LatLng?t.call(o,e):e instanceof google.maps.Data.Point?t.call(o,e.get()):e.getArray().forEach((function(e){a._processPoints(e,t,o)}))},_loadGeoJson:function(e,t){apex.debug("_loadGeoJson",e),features=this.map.data.addGeoJson(e,t);var o=this;this.map.data.forEach((function(e){o._processPoints(e.getGeometry(),o.bounds.extend,o.bounds)})),this.options.autoFitBounds&&this.map.fitBounds(this.bounds),apex.jQuery("#"+this.options.regionId).trigger("loadedgeojson",{map:this.map,geoJson:e,features:features})},loadGeoJsonString:function(e){if(apex.debug("reportmap.loadGeoJsonString",e),e){var t=JSON.parse(e);this.bounds=new google.maps.LatLngBounds,this._loadGeoJson(t)}},_initDragDropGeoJSON:function(){apex.debug("reportmap._initDragDropGeoJSON");var e=this,t=document.getElementById("map_"+this.options.regionId),o=document.getElementById("drop_"+this.options.regionId),a=function(e){return e.stopPropagation(),e.preventDefault(),o.style.display="block",!1};t.addEventListener("dragenter",a,!1),o.addEventListener("dragover",a,!1),o.addEventListener("dragleave",(function(){o.style.display="none"}),!1),o.addEventListener("drop",(function(t){apex.debug("reportmap.drop",t),t.preventDefault(),t.stopPropagation(),o.style.display="none";var a=t.dataTransfer.files;if(a.length)for(var i,s=0;i=a[s];s++){var n=new FileReader;n.onload=function(t){e.loadGeoJsonString(t.target.result)},n.onerror=function(e){apex.error("reading failed")},n.readAsText(i)}else{var r=t.dataTransfer.getData("text/plain");r&&e.loadGeoJsonString(r)}return!1}),!1)},_initDebug:function(){apex.debug("reportmap._initDebug");var e=this,t=document.createElement("div"),o=document.createElement("div");o.className="reportmap-debugPanel",o.innerHTML="[debug mode]",t.appendChild(o),this.map.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(t),google.maps.event.addListener(this.map,"mousemove",(function(e){o.innerHTML="mouse position "+JSON.stringify(e.latLng)})),google.maps.event.addListener(this.map,"bounds_changed",(function(t){o.innerHTML="map bounds "+JSON.stringify(e.map.getBounds())}))},_getWindowPath:function(){apex.debug("reportmap._getWindowPath");var e=window.location.origin+window.location.pathname;return e.indexOf("/r/")>-1?(apex.debug("Friendly URL detected",e),e=(e=e.substring(0,e.lastIndexOf("/r/"))).substring(0,e.lastIndexOf("/"))):(apex.debug("Legacy URL detected",e),e=e.substring(0,e.lastIndexOf("/"))),apex.debug("path",e),e},_create:function(){apex.debug("reportmap._create",this.element.prop("id")),apex.debug(JSON.stringify(this.options));var e=this;this.imagePrefix=this._getWindowPath()+"/"+this.options.pluginFilePrefix+"images/m",apex.debug("imagePrefix",this.imagePrefix);var t={minZoom:this.options.minZoom,maxZoom:this.options.maxZoom,zoom:this.options.initialZoom,center:this.options.initialCenter,mapTypeId:this.options.mapType,draggable:this.options.allowPan,zoomControl:this.options.allowZoom,scrollwheel:this.options.allowZoom,disableDoubleClickZoom:!this.options.allowZoom,gestureHandling:this.options.gestureHandling};if(this.options.mapStyle&&(t.styles=this.options.mapStyle),this.map=new google.maps.Map(document.getElementById(this.element.prop("id")),t),this.options.initFn&&(apex.debug("init_javascript_code running..."),this.init=this.options.initFn,this.init(),this.init.delete,apex.debug("init_javascript_code finished.")),this._initFeatures(),this.options.drawingModes&&this._initDrawing(),this.options.dragDropGeoJSON&&this._initDragDropGeoJSON(),apex.debug.getLevel()>0&&this._initDebug(),this.options.expectData&&this.refresh(),google.maps.event.addListener(this.map,"click",(function(t){apex.debug("map clicked",t.latLng),e.options.clickZoomLevel&&(e.options.panOnClick&&e.map.panTo(t.latLng),e.map.setZoom(e.options.clickZoomLevel)),apex.jQuery("#"+e.options.regionId).trigger("mapclick",{map:e.map,lat:t.latLng.lat(),lng:t.latLng.lng()})})),apex.jQuery("#"+this.options.regionId).bind("apexrefresh",(function(){$("#map_"+e.options.regionId).reportmap("refresh")})),apex.debug.getLevel()>0){var o='$("#map_'+e.options.regionId+'").reportmap("instance").map';apex.debug("%cThank you for using the jk64 Report Map plugin!\nTo access the Google Map object on this page, use:\n"+o+"\nMore info: https://github.com/jeffreykemp/jk64-plugin-reportmap/wiki","font-size:18px;background-color:#0076ff;color:white;line-height:30px;display:block;padding:10px;")}apex.debug("reportmap._create finished")},_afterRefresh:function(){apex.debug("_afterRefresh"),this.spinner&&(apex.debug("remove spinner"),this.spinner.remove()),apex.jQuery("#"+this.options.regionId).trigger("apexafterrefresh"),this._trigger("change")},_renderPage:function(e,t){if(apex.debug("_renderPage",t),e.mapdata){var o;if(apex.debug("pData.mapdata length:",e.mapdata.length),e.mapdata.length>0){for(var a=0;a<e.mapdata.length;a++){if(e.mapdata[a].error){o=e.mapdata[a].error;break}var i=e.mapdata[a];if("heatmap"==this.options.visualisation)this.bounds.extend({lat:i[0],lng:i[1]}),this.weightedLocations.push({location:new google.maps.LatLng(i[0],i[1]),weight:i[2]});else if("geojson"==this.options.visualisation){var s={};if(i.n&&(s.name=i.n),i.d&&(s.id=i.d),i.f)for(var n=1;n<=10;n++)i.f["a"+n]&&(s["attr"+("0"+n).slice(-2)]=i.f["a"+n]);$.extend(i.geojson,{properties:s}),this._loadGeoJson(i.geojson,{idPropertyName:"id"})}else{this.bounds.extend({lat:i.x,lng:i.y});var r=this._newMarker(i);this.markers.push(r),this.newIdMap.set(i.d,a)}}this.options.autoFitBounds&&(apex.debug("fitBounds",this.bounds.getSouthWest().toJSON(),this.bounds.getNorthEast().toJSON()),this.map.fitBounds(this.bounds)),this.totalRows+=e.mapdata.length}if(o)apex.debug.error(o),this.showMessage(o),delete this.newIdMap,this._afterRefresh();else if(this.totalRows<this.options.maximumRows&&e.mapdata.length==this.options.rowsPerBatch){apex.jQuery("#"+this.options.regionId).trigger("batchloaded",{map:this.map,countPins:this.totalRows,southwest:this.bounds.getSouthWest().toJSON(),northeast:this.bounds.getNorthEast().toJSON()}),t+=this.options.rowsPerBatch;var p=this.options.rowsPerBatch;this.totalRows+p>this.options.maximumRows&&(p=this.options.maximumRows-this.totalRows);var d=this;apex.server.plugin(this.options.ajaxIdentifier,{pageItems:this.options.ajaxItems,x01:t,x02:p},{dataType:"json",success:function(e){apex.debug("next batch received"),d._renderPage(e,t)}})}else{if(0==this.totalRows)delete this.idMap,""!==this.options.noDataMessage&&(apex.debug("show No Data Found infowindow"),this.showMessage(this.options.noDataMessage));else switch(this.options.visualisation){case"directions":this._directions();break;case"cluster":new MarkerClusterer(this.map,this.markers,{imagePath:this.imagePrefix});break;case"spiderfier":this._spiderfy();break;case"heatmap":this.heatmapLayer&&(apex.debug("remove heatmapLayer"),this.heatmapLayer.setMap(null),this.heatmapLayer.delete),this.heatmapLayer=new google.maps.visualization.HeatmapLayer({data:this.weightedLocations,map:this.map,dissipating:this.options.heatmapDissipating,opacity:this.options.heatmapOpacity,radius:this.options.heatmapRadius}),this.weightedLocations.delete}apex.jQuery("#"+this.options.regionId).trigger(this.maploaded?"maprefreshed":"maploaded",{map:this.map,countPins:this.totalRows,southwest:this.bounds.getSouthWest().toJSON(),northeast:this.bounds.getNorthEast().toJSON()}),this.maploaded=!0,this.idMap=this.newIdMap,delete this.newIdMap,this._afterRefresh()}}else this._afterRefresh()},refresh:function(){if(apex.debug("reportmap.refresh"),this.hideMessage(),this.options.expectData){apex.jQuery("#"+this.options.regionId).trigger("apexbeforerefresh"),this.options.showSpinner&&(this.spinner&&this.spinner.remove(),apex.debug("show spinner"),this.spinner=apex.util.showSpinner($("#"+this.options.regionId)));var e=this,t=this.options.rowsPerBatch;this.options.maximumRows<t&&(t=this.options.maximumRows),apex.server.plugin(this.options.ajaxIdentifier,{pageItems:this.options.ajaxItems,x01:1,x02:t},{dataType:"json",success:function(t){apex.debug("first batch received"),e._removeMarkers(),e.weightedLocations=[],e.markers=[],e.bounds=new google.maps.LatLngBounds,e.newIdMap=new Map,t.mapdata&&t.mapdata[0]&&t.mapdata[0].error?(e.showMessage(t.mapdata[0].error),e._afterRefresh()):e._renderPage(t,1)}})}else this._afterRefresh()},_destroy:function(){this.heatmapLayer&&this.heatmapLayer.remove(),this.userpin&&delete this.userpin,this.directionsDisplay&&delete this.directionsDisplay,this.directionsService&&delete this.directionsService,this._removeMarkers(),this.hideMessage(),this.map.remove()},_setOptions:function(){this._superApply(arguments),this.refresh()},_setOption:function(e,t){switch(apex.debug(e,t),e){case"clickableIcons":this.map.setOptions({clickableIcons:t+""=="true"});break;case"disableDefaultUI":this.map.setOptions({disableDefaultUI:t+""=="true"});break;case"fullscreenControl":this.map.setOptions({fullscreenControl:t+""=="true"});break;case"heading":this.map.setOptions({heading:parseInt(t)});break;case"keyboardShortcuts":this.map.setOptions({keyboardShortcuts:t+""=="true"});break;case"mapType":this.map.setMapTypeId(t.toLowerCase()),this._super(e,t);break;case"mapTypeControl":this.map.setOptions({mapTypeControl:t+""=="true"});break;case"maxZoom":this.map.setOptions({maxZoom:parseInt(t)}),this._super(e,t);break;case"minZoom":this.map.setOptions({minZoom:parseInt(t)}),this._super(e,t);break;case"rotateControl":this.map.setOptions({rotateControl:t+""=="true"});break;case"scaleControl":this.map.setOptions({scaleControl:t+""=="true"});break;case"streetViewControl":this.map.setOptions({streetViewControl:t+""=="true"});break;case"styles":this.map.setOptions({styles:t}),this._super("mapStyle",t);break;case"zoomControl":this.map.setOptions({zoomControl:t+""=="true"});break;case"tilt":this.map.setTilt(parseInt(t));break;case"zoom":this.map.setZoom(parseInt(t));break;default:this._super(e,t)}}})}));
//# sourceMappingURL=jk64reportmap_r1.js.map